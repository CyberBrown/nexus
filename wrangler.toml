name = "nexus-mcp"
main = "src/index.ts"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]
account_id = "52b1c60ff2a24fb21c1ef9a429e63261"

[dev]
port = 8787

[[d1_databases]]
binding = "DB"
database_name = "nexus-db"
database_id = "1210076d-a443-443c-8623-a02b5ff4de9f"

[vars]
ENVIRONMENT = "development"
# Nexus self URL for workflow callbacks
NEXUS_URL = "https://nexus-mcp.solamp.workers.dev"
# DE text-gen URL for workflows (workflows can't use service bindings)
TEXT_GEN_URL = "https://de-text-gen.solamp.workers.dev"
# INTAKE URL for workflows (workflows can't use service bindings)
INTAKE_URL = "https://intake.solamp.workers.dev"
# DEPRECATED: Use INTAKE service binding or INTAKE_URL instead
# SANDBOX_EXECUTOR_URL = "https://sandbox-executor.solamp.workers.dev"
# DE_WORKFLOWS_URL = "https://de-workflows.solamp.workers.dev"
# Cloudflare Access - set these for production auth
# TEAM_DOMAIN = "https://your-team.cloudflareaccess.com"
# POLICY_AUD = "your-application-audience-tag"
# MCP Passphrase Auth - set via `npx wrangler secret put WRITE_PASSPHRASE` for production
# WRITE_PASSPHRASE = "stale-coffee-44"

[[kv_namespaces]]
binding = "KV"
id = "4a9097857e284189a3f0dc6211b7fb3f"
preview_id = "a62b4b925b7c40679937e1545c1dff64"

[[durable_objects.bindings]]
name = "INBOX_MANAGER"
class_name = "InboxManager"

[[durable_objects.bindings]]
name = "CAPTURE_BUFFER"
class_name = "CaptureBuffer"

[[durable_objects.bindings]]
name = "SYNC_MANAGER"
class_name = "SyncManager"

[[durable_objects.bindings]]
name = "USER_SESSION"
class_name = "UserSession"

[[durable_objects.bindings]]
name = "IDEA_EXECUTOR"
class_name = "IdeaExecutor"

# DO Migrations - sync with production
[[migrations]]
tag = "v1"
new_sqlite_classes = ["InboxManager"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["CaptureBuffer"]

[[migrations]]
tag = "v3"
new_sqlite_classes = ["SyncManager"]

[[migrations]]
tag = "v4"
new_sqlite_classes = ["UserSession"]

[[migrations]]
tag = "v5"

[[migrations]]
tag = "v6"

[[migrations]]
tag = "v7"

[[migrations]]
tag = "v8"

# v9 - IdeaExecutor already exists in nexus-mcp
[[migrations]]
tag = "v9"

# Service Bindings - Worker-to-Worker communication
[[services]]
binding = "DE"
service = "de-text-gen"  # DE's text-gen worker for LLM operations

[[services]]
binding = "SANDBOX_EXECUTOR"
service = "sandbox-executor"  # Sandbox executor for task execution

[[services]]
binding = "INTAKE"
service = "intake"  # DE intake for workflow-based execution (parallel, durable)

# Cloudflare Workflows - Durable execution for long-running tasks
[[workflows]]
name = "idea-execution-workflow"
binding = "IDEA_EXECUTION_WORKFLOW"
class_name = "IdeaExecutionWorkflow"

# Cron Triggers
[triggers]
crons = [
  "0 0 * * *",     # Daily at midnight UTC - recurring tasks
  "*/15 * * * *"   # Every 15 minutes - task dispatcher
]

# Workflows
[[workflows]]
name = "idea-to-plan-workflow"
binding = "IDEA_TO_PLAN_WORKFLOW"
class_name = "IdeaToPlanWorkflow"

[[workflows]]
name = "task-executor-workflow"
binding = "TASK_EXECUTOR_WORKFLOW"
class_name = "TaskExecutorWorkflow"

[[workflows]]
name = "idea-planning-workflow"
binding = "IDEA_PLANNING_WORKFLOW"
class_name = "IdeaPlanningWorkflow"

# NOTE: Cross-worker workflow bindings are NOT supported by CF Workflows
# CODE_EXECUTION_WORKFLOW is triggered via HTTP to de-workflows worker instead
# See DE_WORKFLOWS_URL in [vars] section

# AI Binding - Cloudflare Workers AI for embeddings, inference, and AI Search
# AI Search is accessed via: env.AI.autorag("nexus-ai-search").aiSearch({ query: "..." })
# Create AI Search index in Cloudflare Dashboard: AI > AI Search > Create
# Link it to the R2 bucket below and it will auto-index documents
[ai]
binding = "AI"

# R2 Bucket - Storage for AI Search documents
# Upload documents here and AI Search will automatically index them
# Supported formats: PDF, HTML, TXT, MD, DOCX, CSV, JSON
# Create bucket: npx wrangler r2 bucket create nexus-ai-search
[[r2_buckets]]
binding = "AI_SEARCH_BUCKET"
bucket_name = "nexus-ai-search"

# Vectorize Index - For custom embeddings (separate from AI Search)
# AI Search has its own built-in vector index
# This is for manual embedding operations if needed
# Create with: npx wrangler vectorize create nexus-ai-search --dimensions=384 --metric=cosine
# DISABLED: API token lacks Vectorize permissions
# [[vectorize]]
# binding = "VECTORIZE"
# index_name = "nexus-ai-search"
